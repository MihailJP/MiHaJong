/*=============================
 * HSPñÉêùÉNÉâÉCÉAÉìÉgMiHaJong
 *     [òaóπèàóùÉãÅ[É`Éì]
 *=============================
 */

#module
#include "const.as"
#deffunc agariproc int _agariPlayer, int FurikomiPlayer, int ActivePlayer, int TsumoAgari, int CurrentSutehai, int _RoundEndType, \
int CurrentSutehaiAkaDora, array RonFlag, var yakuInfo, var GameStat, var GameEnv, int GameMode, \
var tmpUraFlag, var tmpAliceFlag, var ResultDesc
	agariPlayer = _agariPlayer
	RoundEndType = _RoundEndType
	tmpagariflag = 0
	FirstAgariPlayer = agariPlayer
	OyaAgari = -1
	ResultDesc = ""
	tmpUraFlag = 0
	tmpAliceFlag = 0
	AgariPlayerPriority = -1
	origDoraPointer = getDoraPointer(GameStat)
	exportYakuPoint yakuInfo, AgariPointRaw
	if ((RoundEndType == ENDKYOKU_AGARI)||(RoundEndType == ENDKYOKU_CHONBO)) {
		repeat NUM_OF_PLAYERS-1
			switch getRule(RULE_MULTIPLE_MAHJONG)
				case 0: case 1:
					if (cnt > 0) {break}
					swbreak
				case 2: case 3:
					if (cnt > 1) {break}
					swbreak
			swend
			if (cnt > 0) {
				if (TsumoAgari == 0) {
					RoundEndType = ENDKYOKU_AGARI: agariPlayer++: agariPlayer = agariPlayer \ NUM_OF_PLAYERS
					if (agariPlayer == furikomiPlayer) {break}
					if (RonFlag(agariPlayer\NUM_OF_PLAYERS) == 1) {
						setHand GameStat, HAND_TILECODE, TSUMOHAI_INDEX, agariPlayer, CurrentSutehai
						setHand GameStat, HAND_REDTILE, TSUMOHAI_INDEX, agariPlayer, CurrentSutehaiAkaDora
						countyaku GameStat, yakuInfo, agariPlayer\NUM_OF_PLAYERS, furikomiPlayer, TsumoAgari
						chkfuriten FuritenFlag, MachihaiFlag, MachihaiCount, MachihaiTotal, MachiMen, GameStat, agariPlayer\NUM_OF_PLAYERS
						// îõÇËÇñûÇΩÇ≥Ç»Ç¢Ç©ÅAêUíÆÇÃÇ∆Ç´
						if ((getYakuInfo(yakuInfo, YAKUINF_HAN_BASE) <= getShibari(GameStat))||(FuritenFlag == 1)||(getDoujunFuriten(GameStat, agariPlayer) == 1)||((getRule(RULE_RIICHI_SHIBARI) != 0)&&(getRichiFlag(GameStat, RICHI_FLAG, agariPlayer) == RIICHI_NO))) {
							RoundEndType = ENDKYOKU_CHONBO // É`ÉáÉìÉ{Ç…Ç∑ÇÈ
						}
					} else {
						continue cnt
					}
				}
			}
			if (TsumoAgari == 1) {break}
		loop
	}
	repeat NUM_OF_PLAYERS-1
		setDoraPointer GameStat, origDoraPointer
		switch getRule(RULE_MULTIPLE_MAHJONG)
			case 0: case 1:
				if (cnt > 0) {break}
				swbreak
			case 2: case 3:
				if (cnt > 1) {break}
				swbreak
		swend
		if (cnt == 0) {
			agariPlayer = FirstAgariPlayer
			if (TsumoAgari == 0) {
				RoundEndType = ENDKYOKU_AGARI
				setHand GameStat, HAND_TILECODE, TSUMOHAI_INDEX, agariPlayer, CurrentSutehai
				setHand GameStat, HAND_REDTILE, TSUMOHAI_INDEX, agariPlayer, CurrentSutehaiAkaDora
				countyaku GameStat, yakuInfo, agariPlayer\NUM_OF_PLAYERS, furikomiPlayer, TsumoAgari
				chkfuriten FuritenFlag, MachihaiFlag, MachihaiCount, MachihaiTotal, MachiMen, GameStat, agariPlayer\NUM_OF_PLAYERS
				// îõÇËÇñûÇΩÇ≥Ç»Ç¢Ç©ÅAêUíÆÇÃÇ∆Ç´
				if ((getYakuInfo(yakuInfo, YAKUINF_HAN_BASE) <= getShibari(GameStat))||(FuritenFlag == 1)||(getDoujunFuriten(GameStat, agariPlayer) == 1)||((getRule(RULE_RIICHI_SHIBARI) != 0)&&(getRichiFlag(GameStat, RICHI_FLAG, agariPlayer) == RIICHI_NO))) {
					RoundEndType = ENDKYOKU_CHONBO // É`ÉáÉìÉ{Ç…Ç∑ÇÈ
				}
			} else {
				RoundEndType = ENDKYOKU_AGARI
				countyaku GameStat, yakuInfo, agariPlayer\NUM_OF_PLAYERS, furikomiPlayer, TsumoAgari
				chkfuriten FuritenFlag, MachihaiFlag, MachihaiCount, MachihaiTotal, MachiMen, GameStat, agariPlayer\NUM_OF_PLAYERS
				if ((getYakuInfo(yakuInfo, YAKUINF_HAN_BASE) <= getShibari(GameStat))||((getRule(RULE_RIICHI_SHIBARI) != 0)&&(getRichiFlag(GameStat, RICHI_FLAG, ActivePlayer) == RIICHI_NO))) {
					RoundEndType = ENDKYOKU_CHONBO // É`ÉáÉìÉ{Ç…Ç∑ÇÈ
				}
			}
		}
		if (cnt > 0) {
			if (TsumoAgari == 0) {
				RoundEndType = ENDKYOKU_AGARI: agariPlayer++: agariPlayer = agariPlayer \ NUM_OF_PLAYERS
				if (agariPlayer == furikomiPlayer) {break}
				if (RonFlag(agariPlayer\NUM_OF_PLAYERS) == 1) {
					setHand GameStat, HAND_TILECODE, TSUMOHAI_INDEX, agariPlayer, CurrentSutehai
					setHand GameStat, HAND_REDTILE, TSUMOHAI_INDEX, agariPlayer, CurrentSutehaiAkaDora
					countyaku GameStat, yakuInfo, agariPlayer\NUM_OF_PLAYERS, furikomiPlayer, TsumoAgari
					chkfuriten FuritenFlag, MachihaiFlag, MachihaiCount, MachihaiTotal, MachiMen, GameStat, agariPlayer\NUM_OF_PLAYERS
					// îõÇËÇñûÇΩÇ≥Ç»Ç¢Ç©ÅAêUíÆÇÃÇ∆Ç´
					if ((getYakuInfo(yakuInfo, YAKUINF_HAN_BASE) <= getShibari(GameStat))||(FuritenFlag == 1)||(getDoujunFuriten(GameStat, agariPlayer) == 1)||((getRule(RULE_RIICHI_SHIBARI) != 0)&&(getRichiFlag(GameStat, RICHI_FLAG, agariPlayer) == RIICHI_NO))) {
						RoundEndType = ENDKYOKU_CHONBO // É`ÉáÉìÉ{Ç…Ç∑ÇÈ
					}
					exportYakuPoint yakuInfo, AgariPointRaw
				} else {
					continue cnt
				}
			}
		}
		haifualicedoraupd
		/**************/
		/* òaóπê¨óßéû */
		/**************/
		if (RoundEndType == ENDKYOKU_AGARI) {
			tmpagariflag = 1
			if ((getAgariHouki(GameStat, agariPlayer) == 1)||(IsRemotePlayer(GameEnv, agariPlayer) == -1)) {
				RoundEndType = ENDKYOKU_CHONBO // òaóπÇËï˙ä¸éûÇÃèàóùÅ®åÎÉçÉìÅEåÎÉcÉÇÇ∆ÇµÇƒî±ïÑÇ∆Ç∑ÇÈ
			}
		}
		if (RoundEndType == ENDKYOKU_AGARI) {
			chatrecv GameStat, GameEnv, GameMode
			endround_agariproc GameStat, GameEnv, ResultDesc, agariPlayer, FurikomiPlayer, AgariPlayerPriority, TsumoAgari, origDoraPointer, AgariPointRaw, YakuInfo, tmpAliceFlag
		}
		/**************/
		/* çˆòaî≠ê∂éû */
		/**************/
		if (RoundEndType == ENDKYOKU_CHONBO) {
			endround_chonboproc GameStat, ResultDesc, agariPlayer, TsumoAgari
		}

		if (TsumoAgari == 1) {break /* ÉcÉÇòaóπÇËÇÃéûÇÕèIóπ */}
		setDeposit GameStat, 0
		redrscreen: redraw 1
	loop
	RoundEndType = ENDKYOKU_CHONBO-tmpagariflag
	switch getRule(RULE_SIMULTANEOUS_MAHJONG)
		case 0:
			if (OyaAgari == -1) {agariPlayer = FirstAgariPlayer}
			else {agariPlayer = OyaAgari}
			swbreak
		case 1: agariPlayer = FirstAgariPlayer: swbreak
		case 2:
			if (OyaAgari == FirstAgariPlayer) {agariPlayer = FirstAgariPlayer+1}
			else {agariPlayer = FirstAgariPlayer}
			swbreak
	swend

	switch getRule(RULE_PENALTY_NEGATIVE)
		case 1: case 2:
#ifdef SANMAT
			if ((isDobon(GameStat,PLAYER_EAST))||(isDobon(GameStat,PLAYER_SOUTH))||(isDobon(GameStat,PLAYER_WEST))) {
#else
			if ((isDobon(GameStat,PLAYER_EAST))||(isDobon(GameStat,PLAYER_SOUTH))||(isDobon(GameStat,PLAYER_WEST))||(isDobon(GameStat,PLAYER_NORTH))) {
#endif
				dim PointDelta, NUM_OF_PLAYERS, NUM_OF_DIGIT_GROUPS
				repeat NUM_OF_ACTUAL_PLAYERS
					if (isDobon(GameStat,cnt)) {
						PointDelta(cnt) -= 100*getRule(RULE_PENALTY_NEGATIVE)
						PointDelta(AgariPlayerPriority) += 100*getRule(RULE_PENALTY_NEGATIVE)
					}
				loop
				setCenterTitle "îÚÇ—î±ïÑ"
				putdelta PointDelta
				redraw 1: await 3000
				pointcalc GameStat, PointDelta
			}
			swbreak
		case 3: case 4: case 5:
			if (getRule(RULE_CHIP) != 0) {
#ifdef SANMAT
				if ((isDobon(GameStat,PLAYER_EAST))||(isDobon(GameStat,PLAYER_SOUTH))||(isDobon(GameStat,PLAYER_WEST))) {
#else
				if ((isDobon(GameStat,PLAYER_EAST))||(isDobon(GameStat,PLAYER_SOUTH))||(isDobon(GameStat,PLAYER_WEST))||(isDobon(GameStat,PLAYER_NORTH))) {
#endif
					dim PointDelta, NUM_OF_PLAYERS,NUM_OF_DIGIT_GROUPS
					repeat NUM_OF_ACTUAL_PLAYERS
						if (isDobon(GameStat,cnt)) {
							PointDelta(cnt) -= (getRule(RULE_PENALTY_NEGATIVE)-2)
							PointDelta(AgariPlayerPriority) += (getRule(RULE_PENALTY_NEGATIVE)-2)
						}
					loop
					setCenterTitle "îÚÇ—î±ïÑ"
					putchipdelta PointDelta
					redraw 1: await 1500
					repeat NUM_OF_PLAYERS
						addChip GameStat, cnt, PointDelta(cnt)
					loop
				}
			}
			swbreak
	swend
	return
#global

/* òaóπê¨óßéûÇÃèàóù */
#module
#include "const.as"
#deffunc endround_agariproc var GameStat, var GameEnv, var ResultDesc, int agariPlayer, int FurikomiPlayer, var AgariPlayerPriority, \
int TsumoAgari, int origDoraPointer, array AgariPointRaw, array YakuInfo, var tmpAliceFlag
	if (AgariPlayerPriority == -1) {AgariPlayerPriority = agariPlayer}
	if (ResultDesc != "") {ResultDesc += "\n"}
	tmpResultDesc = ""
	switch playerWind(agariPlayer, getRound(GameStat))
		case PLAYER_EAST: tmpResultDesc += "ìåâ∆": swbreak
		case PLAYER_SOUTH: tmpResultDesc += "ìÏâ∆": swbreak
		case PLAYER_WEST: tmpResultDesc += "êºâ∆": swbreak
#ifndef SANMAT
		case PLAYER_NORTH: tmpResultDesc += "ñkâ∆": swbreak
#endif
	swend
	if (TsumoAgari) {
		tmpResultDesc += "ÇÃÉcÉÇòaóπÇË"
	} else {
		switch playerWind(furikomiPlayer, getRound(GameStat))
			case PLAYER_EAST: tmpResultDesc += "Ç™ìåâ∆Ç©ÇÁÉçÉìòaóπÇË": swbreak
			case PLAYER_SOUTH: tmpResultDesc += "Ç™ìÏâ∆Ç©ÇÁÉçÉìòaóπÇË": swbreak
			case PLAYER_WEST: tmpResultDesc += "Ç™êºâ∆Ç©ÇÁÉçÉìòaóπÇË": swbreak
#ifndef SANMAT
			case PLAYER_NORTH: tmpResultDesc += "Ç™ñkâ∆Ç©ÇÁÉçÉìòaóπÇË": swbreak
#endif
		swend
	}
	ResultDesc += tmpResultDesc
	chatappend "*** "+tmpResultDesc+"\n"
	statmes tmpResultDesc
	await 1500
	tmpDoraPointer = origDoraPointer
	AlicePointer = tmpDoraPointer-getYakuInfo(YakuInfo, YAKUINF_ALICEDORA)*2-2
	if ((getMenzen(GameStat, agariPlayer) == 1)&&(getRule(RULE_ALICE) != 0)) {
		setCenterTitle "ÉAÉäÉXîªíË"
		repeat
			if (getDoraPointer(GameStat) <= AlicePointer) {break}
			setDoraPointer GameStat, getDoraPointer(GameStat) - 2
			dsplay@ SND_MEKURI
			redrscreen: await 1200
		loop
		setDoraPointer GameStat, tmpDoraPointer
		tmpAliceFlag = 1
	}
	bgmstop
	dim PointDelta, NUM_OF_PLAYERS, NUM_OF_DIGIT_GROUPS
	if (isPaoAgari(GameStat, agariPlayer)) {
		// ïÔìKópéû
		if (playerwind(agariPlayer, getRound(GameStat)) == PLAYER_EAST) {
			// êeÇÃòaóπÇË
			OyaAgari = agariPlayer
			if (TsumoAgari) {
				repeat NUM_OF_ACTUAL_PLAYERS
					if (cnt == agariPlayer) {
						agaricalc agariPointArray, AgariPointRaw, 6, 0, 0
						deltacalcplus AgariPointRaw, PointDelta, 6, cnt
					}
					if (isPao(GameStat, agariPlayer, cnt)) {
						deltacalcminus AgariPointRaw, PointDelta, 6, cnt
					}
				loop
			} else {
				repeat NUM_OF_ACTUAL_PLAYERS
					if (cnt == agariPlayer) {
						agaricalc agariPointArray, AgariPointRaw, 3, 3, 1
						deltacalcplus AgariPointRaw, PointDelta, 3, cnt
						deltacalcplus AgariPointRaw, PointDelta, 3, cnt
					}
					if (cnt == furikomiPlayer) {
						deltacalcminus AgariPointRaw, PointDelta, 3, cnt
					}
					if (isPao(GameStat, agariPlayer, cnt)) {
						deltacalcminus AgariPointRaw, PointDelta, 3, cnt
					}
				loop
			}
		} else {
			// éqÇÃòaóπÇË
			if (TsumoAgari) {
				repeat NUM_OF_ACTUAL_PLAYERS
					if (cnt == agariPlayer) {
						agaricalc agariPointArray, AgariPointRaw, 4, 0, 0
						deltacalcplus AgariPointRaw, PointDelta, 4, cnt
					}
					if (isPao(GameStat, agariPlayer, cnt)) {
						deltacalcminus AgariPointRaw, PointDelta, 4, cnt
					}
				loop
			} else {
				repeat NUM_OF_ACTUAL_PLAYERS
					if (cnt == agariPlayer) {
						agaricalc agariPointArray, AgariPointRaw, 2, 2, 1
						deltacalcplus AgariPointRaw, PointDelta, 2, cnt
						deltacalcplus AgariPointRaw, PointDelta, 2, cnt
					}
					if (cnt == furikomiPlayer) {
						deltacalcminus AgariPointRaw, PointDelta, 2, cnt
					}
					if (isPao(GameStat, agariPlayer, cnt)) {
						deltacalcminus AgariPointRaw, PointDelta, 2, cnt
					}
				loop
			}
		}
	} else {
		// í èÌéû
		if (playerwind(agariPlayer, getRound(GameStat)) == PLAYER_EAST) {
			// êeÇÃòaóπÇË
			OyaAgari = agariPlayer
			if (TsumoAgari) {
#ifdef ALLSANMA
				switch getRule(RULE_TSUMO_PAYMENT)
#ifdef SANMA4
					case 0:
#endif
#endif
						repeat NUM_OF_ACTUAL_PLAYERS
							if (cnt == agariPlayer) {
								agaricalc agariPointArray, AgariPointRaw, 2, 2, 2
								deltacalcplus AgariPointRaw, PointDelta, 2, cnt
								deltacalcplus AgariPointRaw, PointDelta, 2, cnt
								deltacalcplus AgariPointRaw, PointDelta, 2, cnt
							} else {
								deltacalcminus AgariPointRaw, PointDelta, 2, cnt
							}
						loop
#ifdef ALLSANMA
#ifdef SANMA4
						swbreak
#endif
					case 2: case 3
						repeat NUM_OF_ACTUAL_PLAYERS
							if (cnt == agariPlayer) {
								agaricalc agariPointArray, AgariPointRaw, 2, 2, 1
								deltacalcplus AgariPointRaw, PointDelta, 2, cnt
								deltacalcplus AgariPointRaw, PointDelta, 2, cnt
								if (getRule(RULE_TSUMO_PAYMENT) == 3) {PointDelta(cnt, 0) += 20}
							} else: if (playerwind(cnt, getRound(GameStat)) != PLAYER_NORTH) {
								deltacalcminus AgariPointRaw, PointDelta, 2, cnt
								if (getRule(RULE_TSUMO_PAYMENT) == 3) {PointDelta(cnt, 0) -= 10}
							}
						loop
						swbreak
					default:
						repeat NUM_OF_ACTUAL_PLAYERS
							if (cnt == agariPlayer) {
								agaricalc agariPointArray, AgariPointRaw, 3, 3, 1
								deltacalcplus AgariPointRaw, PointDelta, 3, cnt
								deltacalcplus AgariPointRaw, PointDelta, 3, cnt
							} else: if (playerwind(cnt, getRound(GameStat)) != PLAYER_NORTH) {
								deltacalcminus AgariPointRaw, PointDelta, 3, cnt
							}
						loop
						swbreak
				swend
#endif
			} else {
				repeat NUM_OF_ACTUAL_PLAYERS
					if (cnt == agariPlayer) {
						agaricalc agariPointArray, AgariPointRaw, 6, 0, 0
						deltacalcplus AgariPointRaw, PointDelta, 6, cnt
					}
					if (cnt == furikomiPlayer) {
						deltacalcminus AgariPointRaw, PointDelta, 6, cnt
					}
				loop
			}
		} else {
			// éqÇÃòaóπÇË
			if (TsumoAgari) {
#ifdef ALLSANMA
				switch getRule(RULE_TSUMO_PAYMENT)
#ifdef SANMA4
					case 0:
#endif
#endif
						repeat NUM_OF_ACTUAL_PLAYERS
							if (cnt == agariPlayer) {
								agaricalc agariPointArray, AgariPointRaw, 2, 1, 2
								deltacalcplus AgariPointRaw, PointDelta, 2, cnt
								deltacalcplus AgariPointRaw, PointDelta, 1, cnt
								deltacalcplus AgariPointRaw, PointDelta, 1, cnt
							} else: if (playerwind(cnt, getRound(GameStat)) == PLAYER_EAST) {
								deltacalcminus AgariPointRaw, PointDelta, 2, cnt
							} else {
								deltacalcminus AgariPointRaw, PointDelta, 1, cnt
							}
						loop
#ifdef ALLSANMA
#ifdef SANMA4
						swbreak
					case 1:
#else
					case 0:
#endif
						repeat NUM_OF_ACTUAL_PLAYERS
							if (cnt == agariPlayer) {
								agaricalc agariPointArray, AgariPointRaw, 2, 2, 1
								deltacalcplus AgariPointRaw, PointDelta, 2, cnt
								deltacalcplus AgariPointRaw, PointDelta, 2, cnt
							} else: if (playerwind(cnt, getRound(GameStat)) != PLAYER_NORTH) {
								deltacalcminus AgariPointRaw, PointDelta, 2, cnt
							}
						loop
						swbreak
					case 2: case 3:
						repeat NUM_OF_ACTUAL_PLAYERS
							if (cnt == agariPlayer) {
								agaricalc agariPointArray, AgariPointRaw, 2, 1, 1
								deltacalcplus AgariPointRaw, PointDelta, 2, cnt
								deltacalcplus AgariPointRaw, PointDelta, 1, cnt
								if (getRule(RULE_TSUMO_PAYMENT) == 3) {PointDelta(cnt, 0) += 20}
							} else: if (playerwind(cnt, getRound(GameStat)) == PLAYER_EAST) {
								deltacalcminus AgariPointRaw, PointDelta, 2, cnt
								if (getRule(RULE_TSUMO_PAYMENT) == 3) {PointDelta(cnt, 0) -= 10}
							} else: if (playerwind(cnt, getRound(GameStat)) != PLAYER_NORTH) {
								deltacalcminus AgariPointRaw, PointDelta, 1, cnt
								if (getRule(RULE_TSUMO_PAYMENT) == 3) {PointDelta(cnt, 0) -= 10}
							}
						loop
						swbreak
					case 4:
						repeat NUM_OF_ACTUAL_PLAYERS
							if (cnt == agariPlayer) {
								agaricalc2 agariPointArray, AgariPointRaw, 8.0/3.0, 4.0/3.0, 1, 0, 0
								deltacalcplusd AgariPointRaw, PointDelta, 8.0/3.0, cnt
								deltacalcplusd AgariPointRaw, PointDelta, 4.0/3.0, cnt
							} else: if (playerwind(cnt, getRound(GameStat)) == PLAYER_EAST) {
								deltacalcminusd AgariPointRaw, PointDelta, 8.0/3.0, cnt
							} else: if (playerwind(cnt, getRound(GameStat)) != PLAYER_NORTH) {
								deltacalcminusd AgariPointRaw, PointDelta, 4.0/3.0, cnt
							}
						loop
						swbreak
					case 5:
						repeat NUM_OF_ACTUAL_PLAYERS
							if (cnt == agariPlayer) {
								agaricalc2 agariPointArray, AgariPointRaw, 2, 1, 1, 0.5, 2
								deltacalcplus AgariPointRaw, PointDelta, 2, cnt
								deltacalcplus AgariPointRaw, PointDelta, 1, cnt
								deltacalcplusd AgariPointRaw, PointDelta, 0.5, cnt
								deltacalcplusd AgariPointRaw, PointDelta, 0.5, cnt
							} else: if (playerwind(cnt, getRound(GameStat)) == PLAYER_EAST) {
								deltacalcminus AgariPointRaw, PointDelta, 2, cnt
								deltacalcminusd AgariPointRaw, PointDelta, 0.5, cnt
							} else: if (playerwind(cnt, getRound(GameStat)) != PLAYER_NORTH) {
								deltacalcminus AgariPointRaw, PointDelta, 1, cnt
								deltacalcminusd AgariPointRaw, PointDelta, 0.5, cnt
							}
						loop
						swbreak
				swend
#endif
			} else {
				repeat NUM_OF_ACTUAL_PLAYERS
					if (cnt == agariPlayer) {
						agaricalc agariPointArray, AgariPointRaw, 4, 0, 0
						deltacalcplus AgariPointRaw, PointDelta, 4, cnt
					}
					if (cnt == furikomiPlayer) {
						deltacalcminus AgariPointRaw, PointDelta, 4, cnt
					}
				loop
			}
		}
	}
	if (getRule(RULE_WAREME) != 0) {
		// äÑÇÍñ⁄ÉãÅ[Éã
		if (getWareme(GameStat) == agariPlayer) {
			// äÑÇÍñ⁄ÇÃêlÇ™òaóπÇ¡ÇΩÇ∆Ç´
			deltadouble PointDelta, PLAYER_EAST
			deltadouble PointDelta, PLAYER_SOUTH
			deltadouble PointDelta, PLAYER_WEST
#ifndef SANMAT
			deltadouble PointDelta, PLAYER_NORTH
#endif
		} else {
			// äÑÇÍñ⁄ÇÃêlà»äOÇ™òaóπÇ¡ÇΩÇ∆Ç´
			deltawareme PointDelta, agariPlayer, getWareme(GameStat)
			deltadouble PointDelta, getWareme(GameStat)
		}
	}
	if ((getRule(RULE_WAREME) == 2)&&(getDice(GameStat, 0, 0) == getDice(GameStat, 1, 0))) {
		// ÉTÉCÉRÉçÇ™É]Éçñ⁄ÇÃéûÇÕÇ≥ÇÁÇ…î{
		if (getWareme(GameStat) == agariPlayer) {
			// äÑÇÍñ⁄ÇÃêlÇ™òaóπÇ¡ÇΩÇ∆Ç´
			deltadouble PointDelta, PLAYER_EAST
			deltadouble PointDelta, PLAYER_SOUTH
			deltadouble PointDelta, PLAYER_WEST
#ifndef SANMAT
			deltadouble PointDelta, PLAYER_NORTH
#endif
		} else {
			// äÑÇÍñ⁄ÇÃêlà»äOÇ™òaóπÇ¡ÇΩÇ∆Ç´
			deltawareme PointDelta, agariPlayer, getWareme(GameStat)
			deltadouble PointDelta, getWareme(GameStat)
		}
	}
	if (getRule(RULE_DOUKASEN) != 0) {
		// ì±âŒê¸ÉãÅ[Éã
		if (getDoukasen(GameStat) == agariPlayer) {
			// ì±âŒê¸ÇÃêlÇ™òaóπÇ¡ÇΩÇ∆Ç´
			deltadouble PointDelta, PLAYER_EAST
			deltadouble PointDelta, PLAYER_SOUTH
			deltadouble PointDelta, PLAYER_WEST
#ifndef SANMAT
			deltadouble PointDelta, PLAYER_NORTH
#endif
		} else {
			// ì±âŒê¸ÇÃêlà»äOÇ™òaóπÇ¡ÇΩÇ∆Ç´
			deltawareme PointDelta, agariPlayer, getDoukasen(GameStat)
			deltadouble PointDelta, getDoukasen(GameStat)
		}
	}
	agariscrproc GameStat, GameEnv, yakuInfo, TsumoAgari, agariPlayer, furikomiPlayer, agariPointArray, ChipAmount, ResultDesc, tmpUraFlag /* òaóπâÊñ  */
	if ((getMenzen(GameStat, agariPlayer) == 1)&&(getRule(RULE_ALICE) != 0)) {
		setDoraPointer GameStat, AlicePointer
	}
	
	setCenterTitle "òaóπì_"
	putdelta PointDelta
	redraw 1: await 1500
	pointcalc GameStat, PointDelta
	
	if ((getHonba(GameStat))&&(getRule(RULE_TSUMIBOH_RATE) != 3)) {
		dim PointDelta, NUM_OF_PLAYERS, NUM_OF_DIGIT_GROUPS
#ifdef SANMAT
		if (playerwind(agariPlayer, getRound(GameStat)) == PLAYER_EAST) {
			if (TsumoAgari) {
				repeat NUM_OF_ACTUAL_PLAYERS
					if (cnt == agariPlayer) {
						PointDelta(cnt) += (getHonba(GameStat)*2)*(getRule(RULE_TSUMIBOH_RATE)*2+1)
					} else {
						PointDelta(cnt) -= getHonba(GameStat)*(getRule(RULE_TSUMIBOH_RATE)*2+1)
					}
				loop
			} else {
				repeat NUM_OF_ACTUAL_PLAYERS
					if (cnt == agariPlayer) {
						PointDelta(cnt) += (getHonba(GameStat)*2)*(getRule(RULE_TSUMIBOH_RATE)*2+1)
					}
					if (cnt == furikomiPlayer) {
						PointDelta(cnt) -= (getHonba(GameStat)*2)*(getRule(RULE_TSUMIBOH_RATE)*2+1)
					}
				loop
			}
		} else {
			if (TsumoAgari) {
				repeat NUM_OF_ACTUAL_PLAYERS
					if (cnt == agariPlayer) {
						PointDelta(cnt) += (getHonba(GameStat)*2)*(getRule(RULE_TSUMIBOH_RATE)*2+1)
					} else {
						PointDelta(cnt) -= getHonba(GameStat)*(getRule(RULE_TSUMIBOH_RATE)*2+1)
					}
				loop
			} else {
				repeat NUM_OF_ACTUAL_PLAYERS
					if (cnt == agariPlayer) {
						PointDelta(cnt) += (getHonba(GameStat)*2)*(getRule(RULE_TSUMIBOH_RATE)*2+1)
					}
					if (cnt == furikomiPlayer) {
						PointDelta(cnt) -= (getHonba(GameStat)*2)*(getRule(RULE_TSUMIBOH_RATE)*2+1)
					}
				loop
			}
		}
#else
		if (playerwind(agariPlayer, getRound(GameStat)) == PLAYER_EAST) {
			if (TsumoAgari) {
				repeat NUM_OF_ACTUAL_PLAYERS
					if (cnt == agariPlayer) {
						PointDelta(cnt) += (getHonba(GameStat)*3)*(getRule(RULE_TSUMIBOH_RATE)*2+1)
					} else {
						PointDelta(cnt) -= getHonba(GameStat)*(getRule(RULE_TSUMIBOH_RATE)*2+1)
					}
				loop
			} else {
				repeat NUM_OF_ACTUAL_PLAYERS
					if (cnt == agariPlayer) {
						PointDelta(cnt) += (getHonba(GameStat)*3)*(getRule(RULE_TSUMIBOH_RATE)*2+1)
					}
					if (cnt == furikomiPlayer) {
						PointDelta(cnt) -= (getHonba(GameStat)*3)*(getRule(RULE_TSUMIBOH_RATE)*2+1)
					}
				loop
			}
		} else {
			if (TsumoAgari) {
				repeat NUM_OF_ACTUAL_PLAYERS
					if (cnt == agariPlayer) {
						PointDelta(cnt) += (getHonba(GameStat)*3)*(getRule(RULE_TSUMIBOH_RATE)*2+1)
					} else: if (playerwind(cnt, getRound(GameStat)) == PLAYER_EAST) {
						PointDelta(cnt) -= getHonba(GameStat)*(getRule(RULE_TSUMIBOH_RATE)*2+1)
					} else {
						PointDelta(cnt) -= getHonba(GameStat)*(getRule(RULE_TSUMIBOH_RATE)*2+1)
					}
				loop
			} else {
				repeat NUM_OF_ACTUAL_PLAYERS
					if (cnt == agariPlayer) {
						PointDelta(cnt) += (getHonba(GameStat)*3)*(getRule(RULE_TSUMIBOH_RATE)*2+1)
					}
					if (cnt == furikomiPlayer) {
						PointDelta(cnt) -= (getHonba(GameStat)*3)*(getRule(RULE_TSUMIBOH_RATE)*2+1)
					}
				loop
			}
		}
#endif
		// äÑÇÍñ⁄Ç≈êœÇ›ñ_Ç‡ÇQî{Ç…Ç»ÇÈ
		if (getRule(RULE_WAREME) != 0) {
			// äÑÇÍñ⁄ÉãÅ[Éã
			if (getWareme(GameStat) == agariPlayer) {
				// äÑÇÍñ⁄ÇÃêlÇ™òaóπÇ¡ÇΩÇ∆Ç´
				PointDelta(PLAYER_EAST) += PointDelta(PLAYER_EAST)
				PointDelta(PLAYER_SOUTH) += PointDelta(PLAYER_SOUTH)
				PointDelta(PLAYER_WEST) += PointDelta(PLAYER_WEST)
#ifndef SANMAT
				PointDelta(PLAYER_NORTH) += PointDelta(PLAYER_NORTH)
#endif
			} else {
				// äÑÇÍñ⁄ÇÃêlà»äOÇ™òaóπÇ¡ÇΩÇ∆Ç´
				PointDelta(agariPlayer) -= PointDelta(getWareme(GameStat))
				PointDelta(getWareme(GameStat)) += PointDelta(getWareme(GameStat))
			}
		}
		if ((getRule(RULE_WAREME) == 2)&&(getDice(GameStat, 0, 0) == getDice(GameStat, 1, 0))) {
			// ÉTÉCÉRÉçÇ™É]Éçñ⁄ÇÃéûÇÕÇ≥ÇÁÇ…î{
			if (getWareme(GameStat) == agariPlayer) {
				// äÑÇÍñ⁄ÇÃêlÇ™òaóπÇ¡ÇΩÇ∆Ç´
				PointDelta(PLAYER_EAST) += PointDelta(PLAYER_EAST)
				PointDelta(PLAYER_SOUTH) += PointDelta(PLAYER_SOUTH)
				PointDelta(PLAYER_WEST) += PointDelta(PLAYER_WEST)
#ifndef SANMAT
				PointDelta(PLAYER_NORTH) += PointDelta(PLAYER_NORTH)
#endif
			} else {
				// äÑÇÍñ⁄ÇÃêlà»äOÇ™òaóπÇ¡ÇΩÇ∆Ç´
				PointDelta(agariPlayer) -= PointDelta(getWareme(GameStat))
				PointDelta(getWareme(GameStat)) += PointDelta(getWareme(GameStat))
			}
		}
		// äÑÇÍñ⁄Ç≈êœÇ›ñ_Ç‡ÇQî{Ç…Ç»ÇÈ
		if (getRule(RULE_DOUKASEN) != 0) {
			// ì±âŒê¸ÉãÅ[Éã
			if (getDoukasen(GameStat) == agariPlayer) {
				// äÑÇÍñ⁄ÇÃêlÇ™òaóπÇ¡ÇΩÇ∆Ç´
				PointDelta(PLAYER_EAST) += PointDelta(PLAYER_EAST)
				PointDelta(PLAYER_SOUTH) += PointDelta(PLAYER_SOUTH)
				PointDelta(PLAYER_WEST) += PointDelta(PLAYER_WEST)
#ifndef SANMAT
				PointDelta(PLAYER_NORTH) += PointDelta(PLAYER_NORTH)
#endif
			} else {
				// ì±âŒê¸ÇÃêlà»äOÇ™òaóπÇ¡ÇΩÇ∆Ç´
				PointDelta(agariPlayer) -= PointDelta(getDoukasen(GameStat))
				PointDelta(getDoukasen(GameStat)) += PointDelta(getDoukasen(GameStat))
			}
		}
		/* ïÔÇÃèÍçá */
		if (isPaoAgari(GameStat, agariPlayer)) {
			PaoPlayer = getPaoPlayer(GameStat, agariPlayer)
			if (TsumoAgari) {
				repeat NUM_OF_ACTUAL_PLAYERS
					if ((PaoPlayer != cnt)&&(agariPlayer != cnt)) {
						PointDelta(agariPlayer) += PointDelta(cnt)
						PointDelta(cnt) -= PointDelta(cnt)
					}
				loop
			} else {
				repeat NUM_OF_ACTUAL_PLAYERS
					if ((PaoPlayer != cnt)&&(furikomiPlayer != cnt)&&(agariPlayer != cnt)) {
						PointDelta(PaoPlayer) += PointDelta(cnt)
						PointDelta(cnt) -= PointDelta(cnt)
					}
				loop
			}
		}

		setCenterTitle "êœñ_ê¥éZ"
		putdelta PointDelta
		redraw 1: await 1500
		pointcalc GameStat, PointDelta
	}
	
	if (getDeposit(GameStat)) {
		dim PointDelta, NUM_OF_PLAYERS, NUM_OF_DIGIT_GROUPS
		PointDelta(agariPlayer, 0) += getDeposit(GameStat)*10
		
		setCenterTitle "ãüëıê¥éZ"
		putdelta PointDelta
		redraw 1: await 1500
		pointcalc GameStat, PointDelta
	}
	
	if ((ChipAmount > 0)&&(getRule(RULE_CHIP) != 0)) {
		dim PointDelta, NUM_OF_PLAYERS, NUM_OF_DIGIT_GROUPS
		if (TsumoAgari == 0) {
			PointDelta(furikomiPlayer) = -ChipAmount
			PointDelta(agariPlayer) = ChipAmount
		} else {
			PointDelta(PLAYER_EAST) = -ChipAmount
			PointDelta(PLAYER_SOUTH) = -ChipAmount
			PointDelta(PLAYER_WEST) = -ChipAmount
#ifndef SANMAT
			PointDelta(PLAYER_NORTH) = -ChipAmount
#endif
			PointDelta(agariPlayer) = ChipAmount*(NUM_OF_ACTUAL_PLAYERS-1)
		}
		setCenterTitle "èjãVê¥éZ"
		putchipdelta PointDelta
		redraw 1: await 1500
		repeat NUM_OF_PLAYERS
			addChip GameStat, cnt, PointDelta(cnt)
		loop
	}
	/* élînòHÇ™ñkâ∆ÇÃï˙èeÇæÇ¡ÇΩèÍçá */
#ifndef SANMAT
	if (playerWind(furikomiPlayer, getRound(GameStat)) == PLAYER_NORTH) {
		yakuname = getYakuInfo(yakuInfo, YAKUINF_YAKULIST)
		if (notesearch(yakuname, "élînòH") >= 0) {
			dim PointDelta, NUM_OF_PLAYERS, NUM_OF_DIGIT_GROUPS
			PointDelta(PLAYER_EAST, 0) = 10
			PointDelta(PLAYER_SOUTH, 0) = 10
			PointDelta(PLAYER_WEST, 0) = 10
			PointDelta(PLAYER_NORTH, 0) = 10
			PointDelta(agariPlayer, 0) = -30
			setCenterTitle "ñkñçî±ïÑ"
			putdelta PointDelta
			redraw 1: await 1500
			pointcalc GameStat, PointDelta
		}
	}
#endif
	return
#global

/* çˆòaî≠ê∂éûÇÃèàóù */
#module
#include "const.as"
#deffunc endround_chonboproc var GameStat, var ResultDesc, int agariPlayer, int TsumoAgari
	if (ResultDesc != "") {ResultDesc += "\n"}
	tmpResultDesc = ""
	switch playerWind(agariPlayer, getRound(GameStat))
		case PLAYER_EAST: tmpResultDesc += "ìåâ∆ÇÃÉ`ÉáÉìÉ{": swbreak
		case PLAYER_SOUTH: tmpResultDesc += "ìÏâ∆ÇÃÉ`ÉáÉìÉ{": swbreak
		case PLAYER_WEST: tmpResultDesc += "êºâ∆ÇÃÉ`ÉáÉìÉ{": swbreak
#ifndef SANMAT
		case PLAYER_NORTH: tmpResultDesc += "ñkâ∆ÇÃÉ`ÉáÉìÉ{": swbreak
#endif
	swend
	ResultDesc += tmpResultDesc+"Ç≈Ç∑"
	chatappend "*** "+tmpResultDesc+"\n"
	statmes tmpResultDesc
	await 1500
	bgmplay_norep MUS_RYUUKYOKU
	setCenterTitle "çˆòa"
	// åÎÉçÉìÇ‹ÇΩÇÕåÎÉcÉÇ
	if ((TsumoAgari == 0)||(TsumoAgari == 1)) {
		if ((getPao(GameStat, PAO_PLAYER_AGARI, PAO_YAKU_MINKAN) != 1)&&(getRule(RULE_MINKAN_PAO) == 6)) {
			// ëÂñæû»ÇÃó‰è„äJâ‘ã÷é~ÉãÅ[ÉãÇÃèÍçá
			setCenterTitle "ñæû»çˆòa": ResultDesc += "(ëÂñæû»ÇÃó‰è„îvÇ≈ÇÃòaóπÇË)"
		}
		else:if ((getRichiFlag(GameStat, RICHI_FLAG, agariPlayer) == RIICHI_NO)&&(getRule(RULE_RIICHI_SHIBARI) != 0)) {
			// óßíºîõÇËÇ≈óßíºÇµÇƒÇ»Ç¢Ç»ÇÁçˆòa
			setCenterTitle "ñŸíÆçˆòa": ResultDesc += "(É_É}íÆÇ≈ÇÃòaóπÇË)"
		}
		else:if ((FuritenFlag == 1)||(getDoujunFuriten(GameStat, agariPlayer) == 1)) {
			// êUíÆÇ»ÇÃÇ…ÉçÉìÇµÇΩèÍçáÇÕçˆòa
			setCenterTitle "êUíÆçˆòa": ResultDesc += "(êUíÆÇ≈ÇÃÉçÉìòaóπÇË)"
		}
		else {
			// òaóπÇËÇ™ê¨óßÇµÇƒÇ¢Ç»Ç¢èÍçáçˆòa
			Shanten = countshanten(GameStat, agariPlayer, SHANTEN_ALL)
			if (Shanten >= 0) {setCenterTitle "ïsíÆçˆòa": ResultDesc += "(ê¨óßÇµÇƒÇ¢Ç»Ç¢òaóπÇË)"}
			else {
				// ñÇ™Ç»Ç©Ç¡ÇΩèÍçáÇÕçˆòa
				countyaku GameStat, yakuInfo, agariPlayer, furikomiPlayer, TsumoAgari
				if (getYakuInfo(yakuInfo, YAKUINF_HAN_BASE) == 0) {setCenterTitle "ñ≥„ çˆòa": ResultDesc += "(ñÇÃÇ»Ç¢òaóπÇË)"}
				else:if ((getYakuInfo(yakuInfo, YAKUINF_HAN_BASE) == 1)&&(getShibari(GameStat) == 1)) {
					// ìÒ„ îõÇËÇ≈ÇP„ ÇµÇ©Ç»Ç¢Ç»ÇÁçˆòa
					setCenterTitle "„ ïsë´çˆòa": ResultDesc += "(àÍ„ ÇµÇ©Ç»Ç¢òaóπÇË)"
				} else:if ((getAgariHouki(GameStat, agariPlayer) == 1)||(IsRemotePlayer(GameEnv, agariPlayer) == -1)) {
					// òaóπÇËï˙ä¸Ç»ÇÃÇ…òaóπÇÎÇ§Ç∆ÇµÇΩ
					setCenterTitle "òaóπï˙ä¸çˆòa": ResultDesc += "(òaóπÇËï˙ä¸ìKópíÜ)"
				} else {setCenterTitle "Å@çˆòaÅ@": ResultDesc += ""}
			}
		}
	}
	// åÎÉçÉìÅAåÎÉcÉÇà»äOÇÃçˆòa
	if (TsumoAgari == AGARI_KUIKAE) {setCenterTitle "ãÚë÷çˆòa": ResultDesc += "(ãÚÇ¢ë÷Ç¶)"} // ãÚÇ¢ë÷Ç¶ÇÇµÇΩÇ∆Ç´
	if (TsumoAgari > 1) {dsplay@ SND_PAGE} else {dsplay@ SND_CUOHU}
	redrscreen: await 5000

	dim PointDelta, NUM_OF_PLAYERS, NUM_OF_DIGIT_GROUPS
#ifdef SANMAT
	if (playerWind(agariPlayer, getRound(GameStat)) == PLAYER_EAST) {
		repeat NUM_OF_ACTUAL_PLAYERS
			if (cnt == agariPlayer) {
				PointDelta(cnt) -= 120
			} else {
				PointDelta(cnt) += 60
			}
		loop
	} else {
		repeat NUM_OF_ACTUAL_PLAYERS
			if (cnt == agariPlayer) {
				PointDelta(cnt) -= 80
			} else {
				PointDelta(cnt) += 40
			}
		loop
	}
#else
	if (playerWind(agariPlayer, getRound(GameStat)) == PLAYER_EAST) {
		repeat NUM_OF_PLAYERS
			if (cnt == agariPlayer) {
				PointDelta(cnt) -= 120
			} else {
				PointDelta(cnt) += 40
			}
		loop
	} else {
		repeat NUM_OF_PLAYERS
			if (cnt == agariPlayer) {
				PointDelta(cnt) -= 80
			} else {
				if (playerWind(cnt, getRound(GameStat)) == PLAYER_EAST) {
					PointDelta(cnt) += 40
				} else {
					PointDelta(cnt) += 20
				}
			}
		loop
	}
#endif
	setCenterTitle "çˆòaî±ïÑ"
	putdelta PointDelta
	redraw 1
	pointcalc GameStat, PointDelta
	return
#global
